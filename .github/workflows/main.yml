name: PlatformIO Build for LOLIN S3 Mini

on:
  push:
    # K√≠ch ho·∫°t khi c√≥ push v√†o c√°c nh√°nh main ho·∫∑c master
    branches: [ "main", "master" ]
  pull_request:
    # K√≠ch ho·∫°t khi c√≥ pull request
    branches: [ "main", "master" ]
  workflow_dispatch:
    # Cho ph√©p ch·∫°y th·ªß c√¥ng

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: üì¶ Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: üêç Set up Python & PlatformIO
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
      
    - name: üß∞ Install PlatformIO Core
      run: pip install platformio

    # ------------------------------------------------------------------
    # T·∫£i v√† s·ª≠a l·ªói th∆∞ vi·ªán ESP32-AudioI2S v2.0.4 (·ªîN ƒê·ªäNH V√Ä T∆Ø∆†NG TH√çCH)
    # L∆ØU √ù: H·∫° c·∫•p ƒë·ªÉ tr√°nh l·ªói driver/i2s_std.h
    # ------------------------------------------------------------------
    - name: üéß Download & Fix ESP32-AudioI2S Library
      run: |
        TAG_VERSION="2.0.4"
        
        # ƒê·ªãnh nghƒ©a c√°c ƒë∆∞·ªùng d·∫´n
        ZIP_URL="https://github.com/schreibfaul1/ESP32-audioI2S/archive/refs/tags/${TAG_VERSION}.zip"
        LIB_DIR="lib/ESP32-audioI2S-${TAG_VERSION}"
        AUDIO_HEADER="${LIB_DIR}/src/Audio.h"
        
        # 1. T·∫£i v√† gi·∫£i n√©n
        mkdir -p lib
        echo "üîΩ T·∫£i th∆∞ vi·ªán ESP32-AudioI2S v${TAG_VERSION}..."
        curl -L -o lib/audio.zip ${ZIP_URL}
        unzip -o lib/audio.zip -d lib/
        
        echo "üõ†Ô∏è B·∫Øt ƒë·∫ßu s·ª≠a l·ªói NetworkClient.h v√† khai b√°o class..."
        
        # 2. S·ª≠a #include <NetworkClient.h> -> #include <WiFiClient.h>
        # D√πng PERL ƒë·ªÉ s·ª≠a (R·∫•t ƒë√°ng tin c·∫≠y)
        perl -pi -e 's/#include <NetworkClient.h>/#include <WiFiClient.h>/g' "${AUDIO_HEADER}"
        
        # 3. S·ª≠a khai b√°o bi·∫øn: NetworkClient client; -> WiFiClient client;
        perl -pi -e 's/NetworkClient(\*?) client/WiFiClient\1 client/g' "${AUDIO_HEADER}"
        
        # 4. X√≥a file zip t·∫°m th·ªùi
        rm lib/audio.zip
        echo "‚úÖ ƒê√£ ho√†n t·∫•t c·∫•u h√¨nh th∆∞ vi·ªán ESP32-AudioI2S."

    # ------------------------------------------------------------------
    # B∆Ø·ªöC BI√äN D·ªäCH
    # ------------------------------------------------------------------
    - name: üöÄ Build Firmware
      run: |
        platformio run

    # ------------------------------------------------------------------
    # B∆Ø·ªöC UPLOAD ARTIFACTS
    # ------------------------------------------------------------------
    - name: üì§ Upload firmware artifact
      uses: actions/upload-artifact@v4
      with:
        name: firmware-lolin-s3-mini
        # ƒê∆∞·ªùng d·∫´n th∆∞ m·ª•c build c·ªßa PlatformIO
        path: .pio/build/lolin_s3_mini/
        retention-days: 7 
